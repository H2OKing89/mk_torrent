# 7.1) HTML Cleaner Service (`services/html_cleaner.py`)

## Overview

The HTML Cleaner service provides robust, safe HTML sanitization with graceful fallback capabilities. It converts HTML content to clean plain text while preserving meaningful content structure.

## Features

### Primary Sanitization (nh3)
- **Modern sanitization** with nh3 library
- **Performance optimized** for high-throughput processing
- **Security focused** with safe defaults
- **Memory efficient** with minimal allocations

### Fallback Sanitization (BeautifulSoup)
- **Graceful degradation** when nh3 unavailable
- **Broad compatibility** across environments
- **Feature parity** with nh3 output
- **Consistent behavior** regardless of backend

### Text Processing
- **Entity unescaping** (HTML entities â†’ Unicode)
- **Whitespace normalization** (collapse multiple spaces/newlines)
- **Idempotent operations** (safe to call multiple times)
- **Encoding handling** (UTF-8 safe throughout)

## Interface

```python
class HTMLCleaner:
    def __init__(self, strict: bool = True, preserve_breaks: bool = False):
        """
        Initialize HTML cleaner.

        Args:
            strict: Use strict sanitization rules
            preserve_breaks: Keep line breaks as \n
        """

    def sanitize(self, html_content: str) -> str:
        """
        Clean HTML content to plain text.

        Args:
            html_content: Raw HTML string

        Returns:
            Clean plain text string
        """

    def is_html(self, content: str) -> bool:
        """
        Detect if content contains HTML markup.

        Args:
            content: String to check

        Returns:
            True if HTML detected
        """
```

## Implementation Details

### nh3 Backend
```python
import nh3

def _sanitize_nh3(self, html: str) -> str:
    """Primary sanitization using nh3."""
    # Strip all tags, keep text content only
    text = nh3.clean(html, tags=set())
    return self._normalize_whitespace(text)
```

### BeautifulSoup Fallback
```python
from bs4 import BeautifulSoup

def _sanitize_bs4(self, html: str) -> str:
    """Fallback sanitization using BeautifulSoup."""
    soup = BeautifulSoup(html, 'html.parser')
    text = soup.get_text()
    return self._normalize_whitespace(text)
```

### Whitespace Normalization
```python
import re

def _normalize_whitespace(self, text: str) -> str:
    """Normalize whitespace in text."""
    # Collapse multiple spaces
    text = re.sub(r' +', ' ', text)

    # Collapse multiple newlines
    if not self.preserve_breaks:
        text = re.sub(r'\n+', ' ', text)
    else:
        text = re.sub(r'\n{3,}', '\n\n', text)

    return text.strip()
```

## Configuration Options

### Strict Mode
- **Enabled (default)**: Remove all HTML tags and attributes
- **Disabled**: Allow safe HTML tags (links, emphasis)

### Preserve Breaks
- **Disabled (default)**: Convert line breaks to spaces
- **Enabled**: Preserve paragraph structure with \n

### Custom Rules
```python
# Example: Custom sanitization rules
cleaner = HTMLCleaner(
    strict=False,
    preserve_breaks=True,
    allowed_tags={'p', 'br', 'em', 'strong'},
    strip_attributes=True
)
```

## Error Handling

### Backend Availability
```python
def __init__(self, strict: bool = True):
    self.strict = strict

    # Detect available backends
    try:
        import nh3
        self.backend = 'nh3'
    except ImportError:
        try:
            import bs4
            self.backend = 'bs4'
        except ImportError:
            raise ImportError("No HTML cleaning backend available")
```

### Graceful Degradation
- Missing nh3: Fall back to BeautifulSoup
- Missing BeautifulSoup: Provide basic regex-based cleaning
- Invalid input: Return empty string with warning
- Encoding errors: Attempt UTF-8 recovery

## Performance Characteristics

### Benchmarks
- **nh3**: ~10x faster than BeautifulSoup for large documents
- **Memory usage**: Linear with input size
- **Throughput**: 1000+ documents/second typical

### Optimization Tips
- Reuse HTMLCleaner instances (compiled regex caching)
- Process in batches for better memory locality
- Use strict mode for maximum performance

## Usage Examples

### Basic Sanitization
```python
cleaner = HTMLCleaner()

# Clean HTML description
html = "<p>Great <em>audiobook</em> with <script>alert('xss')</script>!"
clean = cleaner.sanitize(html)
# Result: "Great audiobook with !"
```

### Preserve Structure
```python
cleaner = HTMLCleaner(preserve_breaks=True)

html = """
<p>Chapter 1: Introduction</p>
<p>This audiobook covers...</p>
<ul><li>Topic A</li><li>Topic B</li></ul>
"""
clean = cleaner.sanitize(html)
# Result: "Chapter 1: Introduction\n\nThis audiobook covers...\n\nTopic A Topic B"
```

### Content Detection
```python
content = "Plain text description"
if not cleaner.is_html(content):
    # Skip processing for plain text
    processed = content
else:
    processed = cleaner.sanitize(content)
```

## Testing Strategy

### Unit Tests
- Test both nh3 and BeautifulSoup backends
- Verify whitespace normalization
- Check entity unescaping
- Validate edge cases (empty, malformed HTML)

### Property Tests
```python
from hypothesis import given, strategies as st

@given(st.text())
def test_idempotent_cleaning(text):
    """Cleaning should be idempotent."""
    first = cleaner.sanitize(text)
    second = cleaner.sanitize(first)
    assert first == second
```

### Security Tests
- XSS attempt neutralization
- Script tag removal
- Attribute stripping
- Unicode normalization

## Dependencies

### Required
- **Python 3.8+**: Modern Python features
- **One of**: nh3 (preferred) OR beautifulsoup4

### Optional
- **nh3 >= 0.2**: Preferred backend
- **beautifulsoup4 >= 4.12**: Fallback backend
- **html5lib**: Advanced HTML parsing

### Installation
```bash
# Preferred setup
pip install nh3

# Fallback setup
pip install beautifulsoup4

# Development setup
pip install nh3 beautifulsoup4 html5lib
```
